# 開発方針書 - ccusage-mac

## 1. プロジェクト概要

### 目的
Claude APIの使用料金をリアルタイムでMacの通知バー（メニューバー）に表示し、開発者がコストを意識しながらClaude APIを利用できるようにする。

### 背景
- `npx ccusage@latest`コマンドはターミナルでの実行が必要
- 常時監視したい場合は都度コマンドを実行する必要がある
- Macユーザーにとってメニューバーアプリは自然なUX

## 2. アーキテクチャ設計

### 2.1 システム構成
```
┌─────────────────────┐
│  Menu Bar App (UI)  │
│     (SwiftUI)       │
└──────────┬──────────┘
           │
┌──────────▼──────────┐
│   Data Fetcher      │
│  (Swift/URLSession) │
└──────────┬──────────┘
           │
┌──────────▼──────────┐
│  Anthropic API      │
│   Usage Endpoint    │
└─────────────────────┘
```

### 2.2 データフロー
1. アプリ起動時に初回データ取得
2. 定期的（5分間隔）に使用量を自動更新
3. 手動更新機能も提供
4. データはメモリ内にキャッシュ（永続化は必要に応じて実装）

## 3. 技術スタック

### 3.1 開発言語・フレームワーク
- **言語**: Swift 5.9+
- **UI Framework**: SwiftUI
- **最小対応OS**: macOS 13.0 (Ventura)
- **ビルドシステム**: Xcode 15+

### 3.2 主要ライブラリ
- **HTTP通信**: URLSession（標準ライブラリ）
- **JSON解析**: Codable（標準ライブラリ）
- **日付処理**: Foundation（標準ライブラリ）
- **テスト**: XCTest

### 3.3 外部依存
最小限の外部依存で実装し、メンテナンス性を高める。

## 4. 機能要件

### 4.1 必須機能
1. **今日の使用料金表示**
   - メニューバーに金額を表示（例: "$36.32"）
   - アイコンまたはテキスト表示を選択可能

2. **詳細情報ポップオーバー**
   - クリックで詳細情報を表示
   - 今日の内訳（Input/Output/Cache/Total Tokens）
   - 使用モデル一覧

3. **データ読み込み**
   - Claude Codeが生成するローカルデータ（~/.claude/projects/）を読み込み
   - API Key不要（Claude Codeが既に認証済みデータを保存）
   - JSONLファイルからの使用状況データ解析

4. **自動更新**
   - 5分間隔での自動更新
   - 手動更新ボタン


## 5. 非機能要件

### 5.1 パフォーマンス
- 起動時間: 1秒以内
- API応答待機: 最大5秒（タイムアウト）
- メモリ使用量: 50MB以下
- CPU使用率: アイドル時1%以下

### 5.2 セキュリティ
- API Key不要（Claude Codeの既存データを読み込むため）
- ローカルファイルアクセスは~/.claude/projects/に制限
- 料金データはLiteLLMの公開リポジトリから取得（HTTPS）
- ローカルキャッシュの暗号化（オプション）

### 5.3 ユーザビリティ
- ダークモード対応
- Retina対応アイコン
- キーボードショートカット対応
- アクセシビリティ対応

## 6. データ取得・処理方針

### 6.1 データソース
- **ローカルファイル**: `~/.claude/projects/**/*.jsonl`
- **Claude Code生成データ**: 各プロジェクト/セッションごとにJSONL形式で保存
- **料金データ**: LiteLLMの公開料金データベースから取得
  - URL: `https://raw.githubusercontent.com/BerriAI/litellm/main/model_prices_and_context_window.json`

### 6.2 データモデル
```swift
struct UsageData: Codable {
    let date: Date
    let models: [String]
    let inputTokens: Int
    let outputTokens: Int
    let cacheCreateTokens: Int
    let cacheReadTokens: Int
    let totalTokens: Int
    let costUSD: Double
}
```

### 6.3 エラーハンドリング
- ファイルアクセスエラー: 適切なエラーメッセージ表示
- JSONLパースエラー: 不正な行をスキップして処理継続
- 料金データ取得エラー: キャッシュまたはフォールバック値を使用

## 7. UI/UX設計方針

### 7.1 デザイン原則
- **シンプル**: 必要最小限の情報表示
- **明瞭**: 一目で今日の使用料金がわかる
- **非侵襲的**: 作業を妨げない

### 7.2 表示形式
- デフォルト: "$金額" 形式
- オプション: アイコン + 金額
- 色分け: 閾値超過時は赤色表示

### 7.3 インタラクション
- シングルクリック: 詳細表示
- 右クリック: コンテキストメニュー
- ホバー: ツールチップ表示

## 8. 開発フロー

### 8.1 フェーズ1（MVP）
1. プロジェクトセットアップ
2. JSONLファイル読み込み機能実装
3. 基本UI実装（メニューバー表示）
4. 料金計算ロジック実装
5. 自動更新機能
6. テスト実装
7. ドキュメント作成

## 9. テスト方針

### 9.1 単体テスト
- API通信モジュール
- データ解析ロジック
- 料金計算ロジック

### 9.2 統合テスト
- JSONLファイル読み込みフロー
- データ更新フロー
- エラーハンドリング


## 10. デプロイ・配布方針

### 10.1 配布方法
1. **GitHub Releases**: DMGファイル配布
2. **Homebrew Cask**: `brew install --cask ccusage-mac`
3. **Mac App Store**: 将来的に検討

### 10.2 更新方式
- Sparkle frameworkによる自動更新
- 手動更新オプション

### 10.3 ライセンス
- MITライセンス（オープンソース）

