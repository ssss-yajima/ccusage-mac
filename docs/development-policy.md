# Development Policy - ccusage-mac

## 1. Project Overview

### Purpose
Display Claude API usage costs in real-time in the Mac menu bar, allowing developers to monitor costs while using Claude API.

### Background
- `npx ccusage@latest` command requires terminal execution
- Continuous monitoring requires repeated command execution
- Menu bar apps provide a natural UX for Mac users

## 2. Architecture Design

### 2.1 System Architecture
```
┌─────────────────────┐
│  Menu Bar App (UI)  │
│     (SwiftUI)       │
└──────────┬──────────┘
           │
┌──────────▼──────────┐
│   Data Fetcher      │
│  (Swift/URLSession) │
└──────────┬──────────┘
           │
┌──────────▼──────────┐
│  Anthropic API      │
│   Usage Endpoint    │
└─────────────────────┘
```

### 2.2 Data Flow
1. Load initial data on app launch
2. Auto-refresh usage every 5 minutes
3. Manual refresh option available
4. Cache data in memory (persistence implemented as needed)

## 3. Technology Stack

### 3.1 Development Language & Framework
- **Language**: Swift 5.9+
- **UI Framework**: SwiftUI
- **Minimum OS**: macOS 13.0 (Ventura)
- **Build System**: Xcode 15+

### 3.2 Core Libraries
- **HTTP Communication**: URLSession (Standard Library)
- **JSON Parsing**: Codable (Standard Library)
- **Date Processing**: Foundation (Standard Library)
- **Testing**: XCTest

### 3.3 External Dependencies
Minimal external dependencies to maximize maintainability.

## 4. Functional Requirements

### 4.1 Core Features
1. **Today's Usage Cost Display**
   - Show cost in menu bar (e.g., "$36.32")
   - Selectable icon or text display

2. **Detailed Information Popover**
   - Click to view detailed breakdown
   - Today's breakdown (Input/Output/Cache/Total Tokens)
   - List of models used

3. **Data Loading**
   - Read local data generated by Claude Code (~/.claude/projects/)
   - No API key required (uses Claude Code's authenticated data)
   - Parse usage data from JSONL files

4. **Auto-refresh**
   - Automatic refresh every 5 minutes
   - Manual refresh button


## 5. Non-functional Requirements

### 5.1 Performance
- Startup time: < 1 second
- API response timeout: 5 seconds max
- Memory usage: < 50MB
- CPU usage: < 1% when idle

### 5.2 Security
- No API key required (reads existing Claude Code data)
- Local file access limited to ~/.claude/projects/
- Pricing data fetched from LiteLLM public repository (HTTPS)
- Local cache encryption (optional)

### 5.3 Usability
- Dark mode support
- Retina display icons
- Keyboard shortcuts
- Accessibility support

## 6. Data Acquisition & Processing

### 6.1 Data Sources
- **Local Files**: `~/.claude/projects/**/*.jsonl`
- **Claude Code Data**: Saved in JSONL format per project/session
- **Pricing Data**: Fetched from LiteLLM public pricing database
  - URL: `https://raw.githubusercontent.com/BerriAI/litellm/main/model_prices_and_context_window.json`

### 6.2 Data Model
```swift
struct UsageData: Codable {
    let date: Date
    let models: [String]
    let inputTokens: Int
    let outputTokens: Int
    let cacheCreateTokens: Int
    let cacheReadTokens: Int
    let totalTokens: Int
    let costUSD: Double
}
```

### 6.3 Error Handling
- File access errors: Display appropriate error messages
- JSONL parse errors: Skip invalid lines and continue
- Pricing data fetch errors: Use cache or fallback values

## 7. UI/UX Design Principles

### 7.1 Design Principles
- **Simple**: Minimal information display
- **Clear**: Today's cost visible at a glance
- **Non-intrusive**: Doesn't interrupt workflow

### 7.2 Display Format
- Default: "$amount" format
- Optional: Icon + amount
- Color coding: Red when threshold exceeded

### 7.3 Interactions
- Single click: Show details
- Right click: Context menu
- Hover: Tooltip display

## 8. Development Flow

### 8.1 Phase 1 (MVP)
1. Project setup
2. JSONL file loading implementation
3. Basic UI implementation (menu bar display)
4. Cost calculation logic
5. Auto-refresh feature
6. Test implementation
7. Documentation

## 9. Testing Strategy

### 9.1 Unit Tests
- API communication module
- Data parsing logic
- Cost calculation logic

### 9.2 Integration Tests
- JSONL file loading flow
- Data refresh flow
- Error handling


## 10. Deployment & Distribution

### 10.1 Distribution Methods
1. **GitHub Releases**: DMG file distribution
2. **Homebrew Cask**: `brew install --cask ccusage-mac`
3. **Mac App Store**: Future consideration

### 10.2 Update Mechanism
- Auto-update via Sparkle framework
- Manual update option

### 10.3 License
- MIT License (Open Source)

